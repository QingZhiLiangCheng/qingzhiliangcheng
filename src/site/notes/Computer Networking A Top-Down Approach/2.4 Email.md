---
{"created":"2025-11-05T17:20","updated":"2025-11-16T14:56","dg-publish":true,"permalink":"/Computer Networking A Top-Down Approach/2.4 Email/","dgPassFrontmatter":true,"noteIcon":""}
---

![Pasted image 20251105201037.png|300](/img/user/accessory/Pasted%20image%2020251105201037.png)
**电子邮件主要包含三个部分**
- 用户代理
- 邮件服务器
- 协议: 包括发送的协议和拉去的协议
	- 发送协议: SMTP(简单邮件传输协议)
	- 拉取协议:  POP3, IMAP, HTTP也可以

**用户代理**
Email的用户代理就是撰写发送接收邮件的客户端软件，比如outlook...
这里补充一下，web应用的用户代理是浏览器；FTP应用的用户代理--FTP客户端的应用软件
那什么是用户代理，就是说你通过这个东西去跟服务器打交道，我们使用这个软件，然后才能执行一些协议动作

**邮件服务器**
邮件服务器在25号端口一直运行
用户代理将邮件发给邮件服务器，存在邮件服务器的队列里，然后从队列中排着队一个一个发给对应的邮件服务器，然后存在对应用户的目录或者说邮箱中，这使用的SMTP协议
用户收邮件的时候通过用户代理客户端，从对应的邮件服务器的邮箱中把别人发送给他的邮件拉出来，POP3，IMAP，HTTP协议都可以

总结一下整个过程就是 发邮件呢就是用户代理把邮件发给邮件服务器。邮件服务器把邮件发给目标邮件服务器(比如qq的邮件服务器发给谷歌的邮件服务器），协议是SMTP；收邮件是用户代理查看相应的邮件服务器看看有没有未读邮件，拉取出来，协议是POP3，IMAP或HTTP

为什么要使用队列？
其中一个原因接收到的邮件比发送的能力大，所以要排队
另一个原因是可能并不是收到邮件立即发送，可以在队列中攒到一定数量一起发送，这样不用让服务器每时每刻都在工作，也提供了邮件撤回的功能


**SMTP的原理**
使用TCP在客户端和服务器之间传输报文，端口号为25
但是要注意客户端不仅仅是用户代理，邮件服务器也可能是客户端，比如从qq的邮件服务器发送给谷歌的邮件服务器，这其中qq的邮件服务器就算客户端
SMTP协议规定的是邮件从我传输给你的这样的一系列动作，包括3个阶段
- 握手
- 传输报文
- 关闭

建立一次连接 关闭之前 可以传多个邮件

发送和接受全部是命令和响应交互的方式，全部是ASCII码的形式
有什么好处？ -- 抓包之后能看得懂
规定了报文必须为7为ASCII码的形式 -- 即它规定了所有的发送的命令和响应的内容以及邮件本身必须在7位ASCII码字符描述的范围之内，换句话说，就是规定了传输的内容必须是ASCII能表示出来
那自然就带来一个问题，传中文怎么办？ 传附件怎么办？ -- 补丁 -- MIME

HTTP和SMTP的区别
- HTTP在Email中是拉的协议，SMTP在Email中是推的协议
- HTTP：每个对象封装在各自的相应报文中；而SMTP多个对象可以包含在一个报文中（比如一份邮件中附了十张图，就会在同一个报文中）

**邮件报文格式**
![Pasted image 20251115161853.png|500](/img/user/accessory/Pasted%20image%2020251115161853.png)

**报文的扩展 -- 多媒体扩展**
比如中文，一个中文两个字符，如果字符不包含在ASCII码中，就需要编码, 扩展 --MIME：多媒体邮件扩展（multimedia mail extension）-- 定义了一种格式，格式中包含了对象，对象中还可以再包含对象
采用base64编码
什么是base64编码？ -- 就是定义了一种约定的映射方式，将若干个不在ASCII码中的字节转换成稍微长一点的符合ASCII码的序列

**POP3 & IMAP协议**
POP3 和 IMAP具有类似的作用，可以从邮件服务器中把邮件拉取出来
不过IMAP比POP3多具备一些特性，比如远程目录的维护，比如IMAP允许在远程邮件服务器中创建服务，把邮件从一个目录搬到另一个目录
POP3邮件客户端和邮件服务器之间的会话分为两个阶段
- 用户确认阶段
- 事物处理阶段


![Pasted image 20251116111532.png|500](/img/user/accessory/Pasted%20image%2020251116111532.png)
注意在POP3中用户确认阶段传输了user和pass都是ASCII，都是明文，所以安全性有问题 -- 那怎么办？
让POP3跑在SSL提供的安全TCP通道上，直接用 SSL/TLS 包住整个 TCP 连接，POP3 服务跑在加密后的连接上。
事务处理阶段，客户端可以像服务器发出命令list列表，然后可以根据retr命令检索报文，换句话说就是从Email用户代理客户端把第一号邮件拉下来，拉完之后客户端发出dele命令，在邮箱当中把第一号邮件删掉 -- 这种叫下载并删除模式
这个下载并删除模式是可以设置的，一旦平板的客户端拉下来之后，如果在pc端在登录邮箱就看不到这封邮件了，这样的好处是邮箱不会满
也可以设置成下载并保留模式
另外，由于POP3不允许在服务器中建目录，因此是无状态的会话
