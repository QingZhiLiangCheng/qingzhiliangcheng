---
{"updated":"2026-01-22T15:01","created":"2026-01-03T23:01","dg-publish":true,"permalink":"/Computer Networking A Top-Down Approach/4.3 IP - Internet Protocol/","dgPassFrontmatter":true,"noteIcon":""}
---

### Overview
网络层有哪些协议？
![Pasted image 20260121130242.png|400](/img/user/accessory/Pasted%20image%2020260121130242.png)
有IP协议 -- 本节课 -- 实现数据平面的转发功能
还有一些路由选择协议，如RIP，OSPF，BGP... ，作用：实现控制平面的路由功能 -- 下一章控制平面的时候会讲
还有ICMP协议，是信令协议，所谓的信令就是测报错等等，测往返延迟(第一轮TTL=1，过完第一跳就抛掉，这样就会像源主机发送一个ICMP报告，从而知道第一条的往返延迟；然后还有TTL=2... )，ping通不通(本质就是发一个ping的request，是一个ICMP的分组，目标回一个ping的response)，都是靠的ICMP的协议
具体来说，路由选择协议会算出一个路由表，IP协议对到来的分组根据分组头部的目的地址字段查路由表，匹配路由表的表项，进行转发。所以IP协议的主要功能就是实现数据平面的转发功能，IP协议会规范地址多长，怎么编，是否分成网络部分，主机部分？ 是否有特殊的地址？ 内网的地址？还会规范数据报的格式等等

### IP数据报格式
![Pasted image 20260121134848.png|500](/img/user/accessory/Pasted%20image%2020260121134848.png)
固定20字节头部，还有一个可选选项Options，选项也属于头部一部分，这样头部就是可变长的，头部中有一个字段就是hend len(头部长度)
ver: IP协议版本号, 这是IPv4的格式
type of service: 数据报中数据的类型，现在这个字段一般废弃不用，这个类型的作用是让路由器等设备在做调度的时候有个依据，设计的时候是这样设计的，后来弃用了。
16-bit identifier：计网书上学的标识；flags：标志；fragment offset: 片偏移量 -- 这三个字段都是分片和重组用的
TTL(time to live): 没过一个路由器减1，减为0的时候会被抛弃掉; 抛掉之后会像源主机发送一个ICMP的错误报告
uper layer: 上层协议，TCP，UDP...  -- IP载荷部分应该交给谁 -- 跟TCP和UDP的端口号是一个道理 -- 表示交给上层的谁
checksum: 头部校验和，数据部分不校验
32bit源IP，32bit目的IP
Options：比如经过路由器的时候，路由器把自己的地址打在Option上，这样目标就能知道来的整个路径
选项之后是数据部分
### IP分片和重组
为什么要分组？
![Pasted image 20260121150104.png|600](/img/user/accessory/Pasted%20image%2020260121150104.png)
假设有一个路由器，路由器是一个三层的设备，有IP层的功能，同时有网络链路层的功能，它插了很多网卡。这里假设其中左边的一个网卡是连接的FDDI网络，右边的一个网卡连接的是以太网
FDDI网络和以太网所传输的最大传输单元MTU(Maximum Transmission Unit)非常大, MTU指的是数据链路层帧所能承载的最大上层数据长度(即IP数据报的整个长度)，不包括数据链路层帧头和帧尾。
以太网的MTU最大为1500B(以太网帧的长度：64-1518字节， MTU或者说数据部分的长度：46-1500字节)
FDDI网络帧的MTU最长是4000B
MTU中承载着一个IP的分组，在FDDI中就是20B的IP头部加3980B的IP body部分
在路由器的IP层面，查路由表，发现从以太网传出去比较好
但是以太网的最大载荷只有1500B
所以就需要分片！

![Pasted image 20260121150957.png|500](/img/user/accessory/Pasted%20image%2020260121150957.png)
这是分片的一些细节
首先，分片后的每一片都要有一个头部，这样后面的路由器才能知道发向哪里
那对于这个例子来说，就需要拷贝20B头部加1480B数据部分；后面第二片，第三片
路由器单独的转发每一片，到目标主机再重组
设计到这么几个问题：
其一：对目标主机而言，怎么知道哥三个是来自同一个分组？ -- 头部的标识identify
其二：三片到达目的主机的顺序可能不一样 -- 头部的片偏移字段 -- 注意片偏移为了方便计算，以1当8，以8个字节为单位，所以第二片的偏移量为185 -- 这也需要再分片的时候需要时8的整数倍！
其三：目的主机怎么知道后面还有没有分片了 -- 头部的MF标志字段(more flag)
其四：在哪里重组？ -- 在目标主机重组 -- 为什么不在下一条接着重组？ 第一个原因是因为这对路由器的压力太大了，而且后面可能还需要继续分片；第二个原因是可能路由表会发生变换，不同的分片可能走的不同的路径
### IPv4地址
首先什么是IP地址，事实上IP地址对设备上一个点(接口, interface)的标识,并不是标识主机或者路由器
路由器一定是做多个网络分组的收入和转发的
一个网络内部的收入和转发是由交换机或者AC(Access Point，无线接入点)来做的
#### 子网Subnet的概念
什么叫在一个子网中？要满足两个条件，其一是IP前缀是一样的，即网络号是一样的，即具备一样的子网号。其二是一个子网内部的收发不需要借助路由器，即一跳可达
最好看子网的方法就是把路由器的接口都断开，形成的一片孤岛就是一个IP子网
![Pasted image 20260121181116.png|200](/img/user/accessory/Pasted%20image%2020260121181116.png)
广义上的子网：上图这三个网络的外部，对于外部更大的网络来说，这三个网络也可能算是一个广义上的子网
![Pasted image 20260121181707.png|400](/img/user/accessory/Pasted%20image%2020260121181707.png)
6个子网

#### IP地址分类
A类网络：地址的最高位为0，第一个字节的其他7个比特代表网络号，后面3个字节24比特代表主机号，所以A类网络有$2^7-2=126$个，为什么减2 -- 全0的网络号和全1的网络号不用了，这是地址的约定；每个网络$2^{24}-2$个主机，全0的属于网络地址，全1的属于广播地址
B类网络：10开头，前两个字节代表网络号，后两个字节代表主机号
C类网络：110开头，前三个字节是网络号，最后一个字节是地址号
ABC类地址叫单播地址
D类叫主播(多播)地址，1110开头，后面的是主播地址，所谓的主播(多播)就是，向主播组的成员转发
E类地址是预留的
![Pasted image 20260121181841.png|500](/img/user/accessory/Pasted%20image%2020260121181841.png)
最原来的划分是没有子网掩码的，看ABC类只需要看开头就好了，比如C类地址，只需要匹配第一个字节就好了
互联网中的路由并不是对单个地址做路由，而是对一个子网做路由，以网络为单位做路由信息的通告、传播和计算；而且在路由信息通告的过程中还不断做路由聚集，路由只是一个要发往的方向！
#### 特殊IP地址
子网部分全为0代表本网络
主机部分全为0代表本主机
主机部分全为1是广播地址
127.x.x.x代表回路地址，所谓的回路地址是不过是TCP还是UDP发下来的分组，到了IP又翻转朝上，又叫测试地址
![Pasted image 20260121184824.png|150](/img/user/accessory/Pasted%20image%2020260121184824.png)
还有一些内网地址或者叫专用地址，每类地址里面都有
- A类：10.0.0.0-10.255.255.255
- B类：172.16.0.0 - 172.31.255.255
- C类：192.168.0.0 - 192.168.255.255

内网地址永远不会当做公用地址来分配，不会与公用地址重复。内网地址是用来在内网中区分不同的设备。换句话说，在家里或者在一个企业中，如果还没有被分配一个正规的IP地址，内部的网络要运行起来，就用192.168来分配地址
#### CIDR(Classless Inter Domain Routing, 无类域间路由)
事实上是B类的主机数太多，没有一个机构的有那么多主机，会浪费；而C类主机数又可能太少，所以就有了无类域间路由。
所谓的无类，就是不再去看A类，B类，C类，（A类第一个字节是网络号，B类前两个字节是网络号，C类前三个字节是网络号），而是任意一个地方劈开，定义网络号和主机号
带来的一个问题，就是查路由表的时候，怎么知道网络号是多少位呢，计算机中的一个机制 -- 掩码 就有了子网掩码 与运算
子网掩码的标识有两种
- 一种是32个比特，用1和0来表示
- 斜杠的表示，比如/23 表示前23位为网络号

#### 转发表
![Pasted image 20260121195630.png|400](/img/user/accessory/Pasted%20image%2020260121195630.png)
有四列：目标子网号(Destination Subnet Num), 掩码(Mask), 下一跳(Next Hop), 端口(Interface)
怎么做匹配？
从IP中取出目标IP地址，与掩码做与运算，获取到子网号，找到相应的表项
转发表记录的只是一个大的方向，到了下一条会有一个更细的划分，所以往外就是子网聚集，往内更细
找到相应的表项就以为这知道了从哪个端口放出去，但是在目标的网络中有很多IP地址，到底谁是你的下一跳，实际上就是下一个路由器的端口的那个IP地址。
知道了下一跳有什么用？通过ARP协议能够查出下一跳下面的网卡的MAC地址，然后交给自己下面的网卡，这样就凑齐了源MAC，目标MAC，网卡知道怎么封装这个帧，就能从这个网卡交给到对面的网卡
如果跟所有的表项都没有匹配上，一定会跟最后一个Default的表项匹配得上，通过默认端口放出，所谓的默认端口就是一个网络的出口路由器所对应的IP，即默认网关

#### 如何获得一个IP地址？
手动配置四个信息：IP地址，子网掩码，默认网关和DNS地址
DHCP(Dynamic Host Configuration Protocol, 动态主机配置协议) -- plug-and-play的形式

#### DHCP
允许主机再加入网络的时候，动态地从服务器哪里获得IP地址
每次从DHCP Server哪里获得IP地址的时候都能获得一个租用期，到期了可以更新
有什么好处？
- 用户不需要自己配IP地址了
- 200个IP能给400个用户提供服务

主机获取IP的流程：
主机上线的时候要广播一样，问有没有活着的DHCP Sever hh -- 发向广播地址(全1)，用什么地址发？-- 主机号全0表示本主机
DHCP Server收到之后，给主机回一个IP地址和相应的配套信息
主机选择，请求我就用这一个地址和相应的配套信息
DHCP Server确定 启用租用期
![Pasted image 20260122143930.png|500](/img/user/accessory/Pasted%20image%2020260122143930.png)
为什么需要再一次握手？ -- 因为可能会有多个DHCP给出应答，主机只需要选择一个

DHCP是驻留在UDP上的DHCP服务

#### 如何获得一块地址?
有两种方式：
- 一种方式是我属于一个老大，这个老大本来就有有了一个大地址块，我切一块，这个就叫子网划分
- 另一种方式是向一个机构申请一个地址块 -- ICAAN(Internet Corporation for Assigned Names and Numbers)

#### 子网划分
假设申请到一个地址块，20位网络号，12位主机号，如果下面有八个机构，怎么分配子网IP地址
如果平均分配，可以再占用3位主机号来作为网络号，这样就分成了 ...000... , ...001... , ...010... , .... 这样八个子网
前面的20位严格来说叫网络号，这3位叫子网号，后面的叫主机号
网络号+子网号相同的网络才算是一个子网：/23
如果主机数量不一样，也可以只对一个大子网再切成两块...

#### 路由聚集(router aggregation)
子网划分反过来其实就是路由聚集
路由通告是说，我告诉你，凡是这个网络前缀的分组你都发给我，我就是你关于这个子网前缀的下一跳
图中从右边数的第2个路由器在接入ISP的时候就能做一个聚集，告诉ISP，凡是前20位相同的，都发给我就行
![Pasted image 20260122150210.png|600](/img/user/accessory/Pasted%20image%2020260122150210.png)
其实上面讲过，路由表是以网络为单位的，越往外层越聚集，它表示的是一个大方向；越往里越具体到小的子网
### NAT:网络地址转换
如果机构只申请了一个IP地址，但是有好多设备要跑，就有了一种技术，叫做NAT(Network Address Translation, 网络地址转换)
![Pasted image 20260122151435.png|500](/img/user/accessory/Pasted%20image%2020260122151435.png)
对于这个图中，10.0.0.1向互联网中发出一个请求，在互联网这一侧，是不认这个10.0.0.1这个地址的，因为这个地址属于是一个内网地址，不向外转发
这里所有的设备都用一个IP地址，出去的时候要把原来的地址全部换成138.76.29.7。进来的时候把138.76.29.7回转回内网地址，发给对应的主机
NAT的几个好处
- 不需要ISP分配一块地址，可用一个IP地址用于所有的局域网设备 -- 省钱
- 局域网内改变设备，无需通知外界
- 改变ISP，分配了一个新的外网地址，不需要更改内部
- 所有的内网都变成了一个地址，外面没法看到内网的结构 -- 安全

需要一个支持NAT的路由器
外出数据包要替换源地址和端口号变成NAT IP地址和新的端口号，目标IP和端口不变
进入数据包替换目标IP和端口号
这就需要记住每个转换替换对 -- NAT转换表
实际上就是需要把外网地址的没用过的一个端口来代替内网的一个IP和端口号，然后把这个对应关系要记下来
![Pasted image 20260122160007.png|500](/img/user/accessory/Pasted%20image%2020260122160007.png)
端口号有6万多个，基本上够了
但是NAT有个争议是：路由器实际上只是一个三层交换设备，而端口号是一个第四层的信息，一个三层设备现在对一个四层信息做了处理：违反了分层原则，违反了端到端的原则(复杂的放到边上，中间需要简单)

出去没问题，但是外网的某个设备没法跟内网的某个设备建立联系 -- 突然想起了远程控制的问题
这就涉及到了NAT穿透的问题
Solution 1: 静态的配好 -- eg(123.76.29.7,port2500) 总是转发到10.0.0.1port25000
Solution 2: UPnP(Universal Plug and Play)协议, 也叫IGD(Internet Gateway Device)协议
![Pasted image 20260122160754.png|200](/img/user/accessory/Pasted%20image%2020260122160754.png)
动态的去查询，增加，删除NAT路由器的表项
Solution 3: 中继
![Pasted image 20260122161018.png|600](/img/user/accessory/Pasted%20image%2020260122161018.png)
### IPv6
IPv6从根本上解决了IPv4地址耗尽的问题，这是最初始的动机
除此之外还有一些别的动机：比如原来每次存储转发都需要重新计算校验和，因为首先TTL-1，还有发生一些分片等 -- IPv6 固定40字节头部，不允许分片，ip地址由32位变为128位
大分组胖分组怎么办？ --  扔掉，同时向源主机发送一个 ICMP v6的分组，告诉源主机每个分组小一点
IPv6头部：
![Pasted image 20260122161840.png|400](/img/user/accessory/Pasted%20image%2020260122161840.png)
- Checksum:被移除掉，降低在每一段中的处理速度
- Options:允许，但是在头部之外,被“Next Header”字段标示 
- ICMPv6:ICMP的新版本 
	- 附加了报文类型,e.g.“PacketTooBig” 
	- 多播组管理功能

IPv4 - IPv6 怎么过渡？
不能采用革命，只能采用过渡
IPv4像一个海洋，IPv6是其中的一些孤岛，里面都是IPv6的通信，边缘有一些双栈协议设备，对内充当IPv6的设备，对外充当IPv4的设备
Ipv4自己通信没问题，IPv6自己通信也没问题，问题就在于一个岛上的IPv6发给另一个岛上的IPv6
这个双栈协议设备会将原来IPv6的分组封装在IPv4的分组中，IPv4相当于小船hh
![Pasted image 20260122164516.png|400](/img/user/accessory/Pasted%20image%2020260122164516.png)
这种技术就叫做隧道技术，像在上个路由之间打一个隧道一样
![Pasted image 20260122164557.png|400](/img/user/accessory/Pasted%20image%2020260122164557.png)
但随着v6越来越多，小岛会慢慢占据整个海洋，这样v4就变成了小岛 -- v4和v4借助v6来传，最后变成全部v6
