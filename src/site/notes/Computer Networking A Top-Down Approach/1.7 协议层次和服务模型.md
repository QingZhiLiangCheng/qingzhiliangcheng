---
{"created":"2025-10-10T13:50","updated":"2025-10-10T22:19","dg-publish":true,"permalink":"/Computer Networking A Top-Down Approach/1.7 协议层次和服务模型/","dgPassFrontmatter":true,"noteIcon":""}
---

### 协议层次
首先我们要承认的一个事实是：**网络是一个非常复杂的一个系统**，这是因为在我们网络中，有各种各样的网络应用，有各种各样的终端形式，各种各样的链路形式。网络所具备的功能除了局部点到点的传输功能之外，还有端到端的路由的这样一个功能，还有可靠的数据交互的功能等等
那怎么去设计这样一个复杂的计算机网络功能呢？
实际上就是模块化的思想，但是模块化的思想有两种方式
- 一种是分解成一种一种的模块，模块之间相互调用，任何一个模块可以为任何一个模块提供功能和服务
- 一种是分层的方法，只有相邻的两个层的模块之间才能够调用和被调用

而计算机网络实际上是采用了分层的方式

**两个例子**
航线系统的例子：
![Pasted image 20251010140835.png|400](/img/user/accessory/Pasted%20image%2020251010140835.png)
两位异地哲学家交流的例子：
![Pasted image 20251010140854.png|500](/img/user/accessory/Pasted%20image%2020251010140854.png)
在异地哲学家交流的例子中，最下面是秘书层，结局异地传输的问题；中间的是翻译层，解决的是语义转换的问题；最上面是哲学家：交换思想。
在整个过程中，是哲学家产生一个思想，通过本地的层间接口交给下层的翻译层，翻译层在拿到思想之后，把它翻译成一个信件的样式，这个信件是一个双方规定好的通用的语言，然后翻译层会加上一些头部的信息，比如希望对方接受的秘书翻译信息，然后交给秘书层; 秘书层借助下层设备锁提供的服务传输
这就对应到我们网络中的两个应用程序交换报文来实现网络应用。
而这其中，两个翻译所商量好的通用的语言，就是协议的一部分。

**更规范的分层的定义**
- 将网络复杂的功能分层功能明确的**层次**，每一层实现了其中一个或一组**功能**，功能中有其上层可以使用的功能：**服务**
- 协议是本层协议实体相互交互执行本层的**协议动作**的集合，目的是实现本层功能，通过接口为上层提供更好的服务
- 在实现本层协议的时候，直接利用了下层所提供的服务
- 本层的服务：借助下层服务实现的本层协议实体之间交互带来的新功能（上层可以利用的）+ 更下层所提供的服务

![Pasted image 20251010144013.png|300](/img/user/accessory/Pasted%20image%2020251010144013.png)
总结来说，本层的协议实体要交换PDU(协议数据单元)，要通过层间接口访问下层所提供的服务来实现，话句话说，想要交换数据，就要依赖于下层所提供的服务。
交换数据的目的是什么? 通过本地的处理，通过数据的交换，通过协议的动作来实现更复杂的功能，更复杂的功能再通过上层的层间接口再像紧邻的上层来提供，而这个复杂的功能包括下面所有的功能 + 一些新功能
协议是水平的关系

**分层的好处和坏处**
好处: 分而治之，可以单独将一部分换成新技术，高内聚低耦合
坏处：子系统之间交换信息会让效率更低

### 服务
服务(Service)：低层实体向上层实体提供它们之间的通信的能力
在服务上有一个服务用户(Service User)和服务提供者(Service Provider)的概念，比如TCP实体可以像上层的三个不同的应用提供服务，TCP实体就是provider, 上层的三个应用就是user
同时还有一个服务访问点SAP(Service Access Point)的概念，比如当TCP像上层的三个应用提供服务，当信息来的时候，需要区分出哪个信息是给哪个服务用户的, 比如socket套接字，端口，ip...
这里简单补充一下Socket套接字，Socket的主要作用就是向下传的时候可以加以标注，到了对方(这个是同层的对方吗，逻辑上是同层传同层，但是得往下传，借助下层服务传)，可以加以区分，是同层的谁传给谁的，有点像快递上标注的信息。
服务用户采用什么形式来使用服务提供者提供的用户？服务提供者采用什么形式向服务用户提供服务？  -- 原语(primitive) ，比如socket api就是一个原语，通过socket api可以采用应用进程和操作系统约定的一些函数来创建socket, 关闭socket，这个就是一种形式，叫原语

**服务的类型**
- 面向连接的服务(Connection-oriented Service)：两个应用之间要建立起链接需要打招呼 -- TCP
- 无连接的服务 -- eg. UDP

### 数据单元(DU)
![Pasted image 20251010201554.png|500](/img/user/accessory/Pasted%20image%2020251010201554.png)
下面这个层n 通过层间接口的SAP(服务访问点) 向上层n+1层提供服务，换句话说，就是在SAP这个地方向上层提供服务，提供服务的形式就是原语(类似一些函数调用)
n+1层交给第n层传输的数据叫做SDU(Service Data Unit, 服务数据单元)，但是在传SDU的时候要加上一些控制信息，叫ICI(Interface Control information, 接口控制信息)，SDU+ICI叫IDU(Interface Data Unit, 接口数据单元)
上层来了一个IDU, SDU是他想传的内容，ICI是上层的控制信息，以便于更加顺利的穿过层间接口，在通过了SAP之后，上层加的那个ICI就没用了，本层会在SDU前面再加上一个本层的控制信息 header，形成了本层的PDU(Protocol Data Unit, 协议数据单元)
最本质的关系就是，上层来个PDU，然后本层加上header变成本层的PDU，然而这是最理想的情况；有时候可能SDU非常的大，就需要在拿到之后把他分成一个一个小块，给这一个一个小块加上header，变成多个n-PDU；当然还有可能SDU非常小，那就回把多个SDU合在一起，加上header，形成n-PDU
这个过程俗称(拆包粘包)
![Pasted image 20251010203250.png|500](/img/user/accessory/Pasted%20image%2020251010203250.png)

协议数据单元在不同的层叫法会不一样
- 应用层的数据单元叫做message(报文)
- 传输层的数据单元叫做报文段或者简称为段(segement)
- 网络层的数据单元通常叫做分组(pacage), 如果这个网络无连接方式来工作的话，叫数据报
- 链路层的数据单元叫做帧(frame)
- 物理层比较含糊，可以叫位

### Internet 协议栈
计算机网络是一个以TCP/IP协议为主的协议簇构成的网络，他把计算机网络的功能分成了5个层次
![Pasted image 20251010210132.png|150](/img/user/accessory/Pasted%20image%2020251010210132.png)
物理层将上层(链路层)交下来的帧(frame)中的每一个比特，一组一组的变成物理信号(电磁波的信号) 传输给对方；接收端把物理媒体上承载的这个物理信号变回原来的数字数据
链路层是网卡与网卡之间的一段链路的连接，传输以帧为单位的数据，链路层需要区分出哪些比特是一个帧的开始，哪些比特是一个帧的结束，中间的那部分就是帧的内容，总结一下就是在**链路层在物理层提供的服务的基础之上，在相邻两点之间传输以帧为单位的数据**
链路层解决的是相邻两点之间的传输(P2P)，但是在网络中，只解决相邻两点的传输是不够的，还要解决源主机与目标主机之间端到端的传输(关系) -- 这是网络层做的事儿，链路层解决的是我们两个点之间有链路连接，你能把帧传给我，我能把帧传给你，仅此而已。**网络层在链路层所提供的相邻两点的数据传输的基础上传输以分组为单位的，端到端的数据传输**(E2E)
仅仅端到端的服务不能够支持应用进程直接跑起来，因为只是主机到主机不够，还要进程到进程，**传输层会借用Socket, 端口等机制做一个进程到进程的区分**, 完成类似主机A的进程1到主机B的进程3的通信；但是传输过程中可能会出错，重复，乱序，丢掉，**传输层的另外一个重要的服务是把网络层提供的可能不可靠的通信服务，变成可靠的通信服务**
**应用进程就可以在传输层所提供的基础之上，完成应用报文和应用报文之间的交互**，然后就可以实现我们所看到的各种功能了

应用层的协议常见的有HTTP, DNS
传输层基本上就两种 TCP, UDP
网络层: IP协议是做转发的，还有路由协议等一些列的协议
链路层和物理层一般都是放在一张网卡上，链路层经常采用的协议是ppp 以太网的协议 WiFi的WLAN的协议
### ISO/OSI 参考模型
除了TCP/IP的模型，还有一个ISO/OSI的参考模型
![Pasted image 20251010220127.png|200](/img/user/accessory/Pasted%20image%2020251010220127.png)
表示层:允许应用解释传输的 数据, e.g., 加密，压缩，机 器相关的表示转换
会话层:数据交换的同步，检 查点，恢复

在TCP/IP中也有表示转换和会话管理的需求，实在应用层做的

### 报文的封装和解封装传输
![Pasted image 20251010220511.png|400](/img/user/accessory/Pasted%20image%2020251010220511.png)
逻辑上是两个应用进程通信，message从一个应用进程直接传给了另一个应用进程
但实际上是通过下层所提供的服务实现的，在到达下层的时候，本层都会加上自己的控制信息
交换机实际上只是到了链路层，上面也学了，链路层能够区分帧头帧尾和中间的帧的数据的部分，帧头中会有目标MAC地址，然后查交换机的站表或者交换表，决定从交换机的哪个端口放出去，然后交给这个端口的网卡(，这个端口的网卡再把帧封装成这条链路的帧，然后又经过物理层变成物理信号打出去
路由器是集成了好多块网卡，不同的网卡和不同的网相连，网卡是有物理层和链路层，然后就能从网卡中取出一个帧，帧的数据部分就是分组，分组中有目标IP的控制信息，查网络层的转发表，决定从哪个网口放出去，然后通过接口把分组交给对应的网卡....
也就是说过交换机是两层的解封装再封装 过路由器是三层的解封装再封装
