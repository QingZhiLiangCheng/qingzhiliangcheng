---
{"created":"2025-11-16T14:57","updated":"2025-11-26T20:49","dg-publish":true,"permalink":"/Computer Networking A Top-Down Approach/2.5 DNS/","dgPassFrontmatter":true,"noteIcon":""}
---

### Overview
#### What is DNS?
DNS(Domain Name System, 域名系统，域名解析系统)，并不是给人用的一个应用层的应用，而是给应用用的一个应用，提供一个域名到ip地址的转换，这算是一种在应用层的基础设施
在网络层工作的一些设备，用ip地址来表示主机，路由器。IP地址算是一种标识，通过指明目的IP地址，就可以把分组发给具备这个IP地址的主机 -- IP地址的两个作用: 1. 标识， 2. 寻址
IP地址的问题，对于IPv4来说，是四个字节32bit的一个数字,IPv6是128bit 16字节的数字。虽然对于IPv4来说，我们有点分十进制的方法来简化记忆，比如10.51.168.195，但仍然是数字。人更倾向于使用有意义的字符串来标识一台设备 -- 存在着字符串IP地址转换的必要性
-> 人类用户提供要访问机器的“字符串”名称，由DNS负责转换成二进制的网络地址，这样应用往下传输层交的就是IP地址，而不是域名

#### DNS系统需要解决的问题
- 问题1：如何命名设备
	- 用有意义的字符串
	- 一个平面命名容易重名，层次化命名
- 问题2: 如何完成名字到IP地址的转换？
	- 一台设备来维护所有命名？ -- 不可行，需要分布式
	- so哪些节点维护哪些范围的域名和ip的对应关系，来进行解析
- 问题3: 如何维护，增加或删除一个域，需要在域名系统中哪些工作

#### DNS总体思路和目标
**主要思路**
- 分层，基于域的命名机制
- 分布式数据库，维护树状关系，来解决名字到ip地址的域名解析问题
- 运行在UDP的53号端口的应用服务 -- 适合UDP,不需要握手
- 核心的Internet功能，但并不是在核心中去实现的，而是以应用层协议实现

主要的服务或者是目的
- 完成主机的域名到ip地址的转换
- 别名到规范名称的转换  （规范名字，是机房的机柜的编号的名字，别名是www.baidu.com。 规范名字是为了便于管理，别名是为了便于用户访问）
- 负载均衡 -- 选择适当的服务器提供服务

### 问题1：DNS名字空间
防止重名 -- 层次化命名
其实就是一棵树，树根分为一个个顶级域，顶级域有两类，一种是通用的，比如.com, .edu, .net ....  还有国家的，.cn, .us，...
每个顶级域再分为若干个二级域 如 edu.cn, gov.cn 
也可以不分，直接挂在顶级域下面 比如mit.edu
像lcu就是挂在二级域名下面 lcu.edu.cn
树叶就是主机名，那么在命名的时候是从树叶往树根走，没过一个层级用一个点来区分，比如xxx.lcu.edu.cn
对域做标识，从树枝往上走，如lcu.edu.cn

但事实上如果根只有一个，如果宕机了，就全宕机了。
实际上互联网的名字的查询的根有13个
这种技术安排的好处，可以从其中最近的一个树根找，如果其中一个树根死掉了，可以找另外一个树根

**域名(domain name)**
- 主机的域名，从树叶往上走，每过一级用点分隔
- 域的域名，从树枝往上走，没过一级用点分隔

但比如lcu.edu.cn下有两个人，都叫张三，那就只能再区分了，张三1，张三2

**域名的管理**
一个域管理其下的子域
创建一个新的域，必须征得其他所属域的同意
域与物理网络无关：域逻辑的名字空间与真正的ip地址的网是没有关系的，换句话说，同一个域的主机可以在不同网络上，在同一个网络的主机可以属于不同的域

### 问题二：域名到ip地址的转换
一个名字服务器的问题
- 可靠性问题: 单点故障 -- 如果死了 整个服务都没法用了
- 扩展性问题：一个服务器旁边的通信容量非常大
- 维护问题：远距离的集中式数据库维护难

-> 分布式解决
**具体怎么分布式解决**
把之前的那棵树 分成一个个zone(区域)，每个zone互不相交，每个区域有一个名字服务器来维护名字与ip的对应关系，这个服务器是关于这个区域的权威名字服务器，知道的名字与ip对应关系的信息是最权威的。
上层区域知道下层区域怎么走

**TLD服务器**
顶级域(TLD)服务器：负责顶级域域名到ip地址的对应关系，除此之外还得知道下层节点的物理位置，ip地址这样的信息

**区域权威服务器维护数据库**
数据库的主要信息有区域内部的一些子域的情况，这个区域的域名到ip地址的对应关系，这些东西叫做resource records(资源记录, RR)
RR具体包括这几个字段
- Domain_name: 域名
- TTL: time to live: 生存时间
- Class类别：对于Internet，值为IN
- Value值，可能是数字，域名或ASCII串
- Type类别：资源记录的类型

TTL是什么？ -- 如果是一个很长很长的无限大的值，就是一个权威记录；如果是一个有限的值，就是一个缓冲记录，隔了这个生存时间之后，就会把这个资源删掉
那TTL有什么用？
权威服务器在维护本区域的权威的域名到ip对应关系的时候，TTL值都是无限大，这是权威记录，会被永久的保留在这个服务器中。但是这个区域的权威服务器也可能会学习到其他区域的一些域名到ip的对应关系，比如聊大的服务器可能学到中科大的域名和ip的对应关系，这就记录成一个缓冲记录。缓冲记录的好处是本地有就直接可以用了，就不需要一直连接连接到中科大的权威服务器去查询了。所以缓冲是为了性能；删除是为了一致性，因为有可能科大的权威服务器一段时间可能会迁移到另一个ip上

**Type: 资源记录的类型**
DNS服务器除了域名到ip的对应关系，还提供的服务有机器的别名到正规名字的转换，邮件服务器的别名到正规名字的转换，下面的子域是如何划分的
![Pasted image 20251124210143.png](/img/user/accessory/Pasted%20image%2020251124210143.png)
其中可能比较迷惑的是Type=NS的情况，简单来说，NS记录就是"这个域名是由哪台DNS服务器负责解析的"，比如想要访问lcu.edu.cn, 浏览器就会问根节点，根节点知道.cn的权威服务器是谁，比如是a.dns.cn，就是a.dns.cn这个主机服务器管.cn这个域名的解析。同时根节点也知道这个权威服务器的IP地址。
具体的过程是这样的：
```text
你 → 根服务器
       返回：
            cn 的 NS 是 a.dns.cn / b.dns.cn
            + 同时返回它们的 IP（Glue）

你 → a.dns.cn
       返回：
            edu.cn 的 NS 是 ns1.edu.cn / ns2.edu.cn
            + 同时返回它们的 IP（Glue）

你 → ns1.edu.cn
       返回：
            lcu.edu.cn 的 NS 是 ns1.lcu.edu.cn / ns2.lcu.edu.cn
            + 同时返回它们的 IP（Glue）

你 → ns1.lcu.edu.cn
       返回：
            cs.lcu.edu.cn 的 NS 是 ns1.cs.lcu.edu.cn / ns2.cs.lcu.edu.cn
            + 同时返回它们的 IP（Glue） ←（如果 NS 在子域内）

你 → ns1.cs.lcu.edu.cn
       返回：
            www.cs.lcu.edu.cn 的 A = 203.0.113.50

```

**DNS具体的解析过程**
![Pasted image 20251124212951.png|500](/img/user/accessory/Pasted%20image%2020251124212951.png)
应用调用解析器(resolver), 解析器作为客户向Name Server发出查询报文(封装在UDP段中)，Name Server返回响应报文(name/ip)
那resolver是怎么知道Local Name Server在哪的？需要配置好
要么是手工配置，要么是通过DHCP这种协议自动配
一个机器上线之后必须要具备的信息: IP地址，子网掩码，Local Name Server, 默认网关(Default Gateway)
其中 默认网关是说一个局域网内部的ip地址，如果想要出去这个网络到其他的网络(子网掩码范围之外），该走哪个路由器，这个路由器的IP地址
那Local Name Server在拿到名字之后，怎么获得这个名字和ip地址的对应关系？
如果有缓存，就直接把缓存的结果返回
如果没有缓存
递归查询，去问根服务器。比如www.lcu.edu.cn，如果local name server没有缓存，就去问.cn, .cn就知道edu.cn的权威服务器... 一直到lcu的服务器，然后返回返回返回...
![Pasted image 20251126201823.png|300](/img/user/accessory/Pasted%20image%2020251126201823.png)

另一种叫迭代查询，local name server去问跟服务器，跟服务器跟他说我不知道，但是我给你一个线索，给你下面顶级域的地址，然后local name server再去问这个服务器...
![Pasted image 20251126202229.png|300](/img/user/accessory/Pasted%20image%2020251126202229.png)
过手的路由器，都会学下来，缓存下来

**DNS协议、报文**
DNS协议：查询和响应报文的报文格式相同
![Pasted image 20251126203149.png|400](/img/user/accessory/Pasted%20image%2020251126203149.png)
![Pasted image 20251126203204.png|400](/img/user/accessory/Pasted%20image%2020251126203204.png)

如果没有ID号，那就只能等响应报文回来了才能发出下一次查询。但有了ID号，这样比如说Local Name Server就可以收很多查询，然后同时发出去，等响应回来和查询对应一下就知道谁查的

**提高性能：缓存**
为了提高性能，一个服务器一旦学到了一个映射，就能将映射缓存起来
根服务器一般都在本地服务器缓存着
目的: 提高效率
可能存在的问题：如果情况变换，缓存结果和权威资源记录不一致
解决方案：TTL(默认2天)

### 问题3：维护问题：新增一个域
在.com这个顶级域下面有很多公司，比如google.com, baidu.com, taobao.com，... 假如现在来了一个新创公司，叫chengzi，需要插入在.com下
实际上是需要插入两条资源数据
- 一条是type=NS这样的资源记录，域名的名字chengzi.com，它的名字服务器的名字，比如ns.chengzi.com，其实就是你想要知道关于chengzi.com的具体的权威信息，去问ns.chengzi.com
- 一条是Type=A的资源记录，名字服务器和IP的对应关系

